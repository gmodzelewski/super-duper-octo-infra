apiVersion: argoproj.io/v1alpha1 
kind: ApplicationSet
metadata:
  name: super-octo-infra
  namespace: openshift-gitops 
spec:
  # generators: 
  # - git:
  #     repoURL: "https://github.com/gmodzelewski/super-duper-octo-infra"
  #     revision: main
  #     files:
  #     - path: "stages/**/config.json"
  # - list:
  #     elements:
  #     - cluster: dev
  #       url: https://kubernetes.default.svc
  #       namespace: gitops-demo-dev
  #       imageTag: "latest"
  #       followChangesForBranch: "main"
  #     - cluster: stage
  #       url: https://kubernetes.default.svc
  #       namespace: gitops-demo-stage
  #       imageTag: "Release-1.0.2"
  #       followChangesForBranch: "Release-1.0" # build when startsWith
  #     - cluster: prod
  #       url: https://kubernetes.default.svc
  #       namespace: gitops-demo-prod
  #       imageTag: "Release-1.0.0"
  #       followChangesForBranch: "" # -> empty means don't follow
  template:
    metadata:
      name: 'super-octo-infra-{{stage}}-app'
    spec:
      project: default 
      source:
        repoURL: "https://github.com/gmodzelewski/super-duper-octo-infra"
        path: neuanfang/super-octo-infra
        helm:
          # valueFiles: 
          # - values.{{cluster}}.yaml
          parameters:
          # - name: feature_flag_workshop_camelk
          #   value: false
          # - name: feature_flag_workshop_gitops
          #   value: false
          # - name: feature_flag_workshop_mta
          #   value: false
          - name: firstrun
            value: true  
      destination:
        server: '{{url}}' 
        namespace: '{{namespace}}'
      syncPolicy: 
        automated:
          selfHeal: true
          prune: true
        # syncOptions:
        # - CreateNamespace=true
      ignoreDifferences:
      - group: image.openshift.io
        kind: ImageStream
        jsonPointers:
        - /spec/tags
      - group: apps.openshift.io
        kind: DeploymentConfig
        jsonPointers:
        - /spec/template/spec/containers/0/image